'use client'

import { useState, useRef, useEffect } from 'react'
import {
  DndContext,
  DragOverlay,
  closestCorners,
  PointerSensor,
  useSensor,
  useSensors,
  DragStartEvent,
  DragEndEvent,
  DragOverEvent,
  useDroppable,
} from '@dnd-kit/core'
import {
  SortableContext,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable'
import Header from './Header'
import NotificationBell from './NotificationBell'
import ResourceCard from './ResourceCard'
import AddActivityModal from './AddActivityModal'
import ActivityCard from './ActivityCard'
import PasswordModal from './PasswordModal'
import CourseObjectives from './CourseObjectives'
import AddTaskModal from './AddTaskModal'
import AddIdeaModal from './AddIdeaModal'
import EditIdeaModal from './EditIdeaModal'
import IdeaCard from './IdeaCard'
import DraggableIdeaCard from './DraggableIdeaCard'
import DraggableTaskCard from './DraggableTaskCard'
import DroppableList from './DroppableList'
import ArrowsOverlay from './ArrowsOverlay'
import ConvergenceModal from './ConvergenceModal'
import VersionControlModal from './VersionControlModal'
import IdeaContributionChart from './IdeaContributionChart'
import IdeaTrendChart from './IdeaTrendChart'
import NetworkGraph from './NetworkGraph'

interface CommunityDetailProps {
  communityName: string
  communityId?: string // å¯é¸çš„ç¤¾ç¾¤ID
  onBack: () => void
}

type TabType = 'resources' | 'activities' | 'ideas' | 'teamwork' | 'history' | 'management'

interface Resource {
  id: string
  fileName: string
  uploadDate: string
  uploadTime: string
  uploaderName?: string
  uploaderId?: string
}

interface Activity {
  id: string
  name: string
  introduction: string
  createdDate: string
  createdTime: string
  isPublic: boolean
  password: string
  creatorId?: string
  creatorName?: string
}

interface KanbanTask {
  id: string
  title: string
  content: string
  startDate: string
  endDate: string
  assignees: string[]
  createdAt?: string // ISO æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆå¯é¸ï¼Œç”¨æ–¼å‘å¾Œå…¼å®¹ï¼‰
}

interface KanbanList {
  id: string
  title: string
  tasks: KanbanTask[]
}

interface Idea {
  id: string
  activityId?: string // é—œè¯çš„å…±å‚™æ´»å‹•ID
  stage: string
  title: string
  content: string
  createdDate: string
  createdTime: string
  creatorName?: string
  creatorAccount?: string // å»ºç«‹è€…å¸³è™Ÿï¼ˆç”¨æ–¼æ¬Šé™æª¢æŸ¥ï¼‰
  creatorAvatar?: string
  parentId?: string // å»¶ä¼¸é—œä¿‚ï¼šæŒ‡å‘çˆ¶ç¯€é»çš„ ID
  position?: { x: number; y: number } // å¡ç‰‡ä½ç½®
  rotation?: number // å¡ç‰‡æ—‹è½‰è§’åº¦
  isConvergence?: boolean // æ˜¯å¦ç‚ºæ”¶æ–‚çµæœç¯€é»
  convergedIdeaIds?: string[] // è¢«æ”¶æ–‚çš„æƒ³æ³•ç¯€é» IDs
}

/**
 * ç¤¾ç¾¤è©³æƒ…é é¢çµ„ä»¶
 * å°æ‡‰ Figma è¨­è¨ˆ (nodeId: 0:1) - ç¤¾ç¾¤è³‡æº(ç©º)
 */
export default function CommunityDetail({ communityName, communityId: propCommunityId, onBack }: CommunityDetailProps) {
  const [activeTab, setActiveTab] = useState<TabType>('resources')
  const [resources, setResources] = useState<Resource[]>([])
  const [activities, setActivities] = useState<Activity[]>([])
  const [ideas, setIdeas] = useState<Idea[]>([])
  const [communityId, setCommunityId] = useState<string | null>(propCommunityId || null)
  const [userId, setUserId] = useState<string | null>(null)
  const [isAddActivityModalOpen, setIsAddActivityModalOpen] = useState(false)
  const [editingActivity, setEditingActivity] = useState<Activity | null>(null)
  const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false)
  const [isVersionControlModalOpen, setIsVersionControlModalOpen] = useState(false)
  const [versionControlActivityId, setVersionControlActivityId] = useState<string | null>(null)
  const [passwordVerifyingActivity, setPasswordVerifyingActivity] = useState<Activity | null>(null)
  const [passwordAction, setPasswordAction] = useState<'edit' | 'view' | 'menu'>('view')
  const [viewingActivity, setViewingActivity] = useState<Activity | null>(null)
  const [passwordVerifiedActivityIds, setPasswordVerifiedActivityIds] = useState<Set<string>>(new Set())
  const fileInputRef = useRef<HTMLInputElement>(null)
  
  // ä½¿ç”¨è€…é ­åƒä¸‹æ‹‰é¸å–®ç‹€æ…‹
  const [isDropdownOpen, setIsDropdownOpen] = useState(false)
  const dropdownRef = useRef<HTMLDivElement>(null)
  const avatarRef = useRef<HTMLDivElement>(null)
  const [userNickname, setUserNickname] = useState('ä½¿ç”¨è€…')
  const [userAccount, setUserAccount] = useState('æœªç™»å…¥')
  
  // åœ˜éšŠåˆ†å·¥ Kanban åˆ—è¡¨ç‹€æ…‹
  const [kanbanLists, setKanbanLists] = useState<KanbanList[]>([])
  const [isAddingList, setIsAddingList] = useState(false)
  const [newListTitle, setNewListTitle] = useState('')
  const [isAddTaskModalOpen, setIsAddTaskModalOpen] = useState(false)
  const [currentListId, setCurrentListId] = useState<string>('')
  const [editingTask, setEditingTask] = useState<{ taskId: string; listId: string } | null>(null)
  const [openTaskMenuId, setOpenTaskMenuId] = useState<string | null>(null)
  const [activeTaskId, setActiveTaskId] = useState<string | null>(null)
  
  // æ‹–æ‹½ sensors é…ç½®
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // ç§»å‹• 8px å¾Œæ‰é–‹å§‹æ‹–æ‹½ï¼Œé¿å…èª¤è§¸
      },
    })
  )
  const [isAddIdeaModalOpen, setIsAddIdeaModalOpen] = useState(false)
  const [editingIdea, setEditingIdea] = useState<Idea | null>(null)
  const [isEditIdeaModalOpen, setIsEditIdeaModalOpen] = useState(false)
  const [extendingFromIdeaId, setExtendingFromIdeaId] = useState<string | null>(null)
  const [isConvergenceModalOpen, setIsConvergenceModalOpen] = useState(false)
  const kanbanInitializedRef = useRef<Set<string>>(new Set()) // è¿½è¹¤æ¯å€‹ç¤¾ç¾¤æ˜¯å¦å·²åˆå§‹åŒ–
  const [openMemberMenuId, setOpenMemberMenuId] = useState<string | null>(null) // é–‹å•Ÿçš„æˆå“¡é¸å–®ID
  const [activeHistoryChart, setActiveHistoryChart] = useState<'contribution' | 'network' | 'trend'>('contribution') // æ´»å‹•æ­·ç¨‹åœ–è¡¨é¡å‹
  const positionUpdateTimeoutRef = useRef<Map<string, NodeJS.Timeout>>(new Map()) // ä½ç½®æ›´æ–°ç¯€æµ
  const lastUpdatePositionRef = useRef<Map<string, { x: number; y: number }>>(new Map()) // è¨˜éŒ„æœ€å¾Œæ›´æ–°ä½ç½®

  // å¾ localStorage è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
  useEffect(() => {
    const loadUserData = () => {
      if (typeof window !== 'undefined') {
        const savedUser = localStorage.getItem('user')
        if (savedUser) {
          try {
            const userData = JSON.parse(savedUser)
            setUserNickname(userData.nickname || 'ä½¿ç”¨è€…')
            setUserAccount(userData.accountNumber || 'æœªç™»å…¥')
            setUserId(userData.id || userData.userId || null)
          } catch (e) {
            // å¿½ç•¥è§£æéŒ¯èª¤
          }
        }
      }
    }
    
    loadUserData()
  }, [])

  // å¦‚æœæ²’æœ‰ communityIdï¼Œæ ¹æ“š communityName æŸ¥è©¢
  useEffect(() => {
    const fetchCommunityId = async () => {
      if (!communityId && communityName) {
        try {
          // å¾ localStorage ç²å–ä½¿ç”¨è€…ID
          const savedUser = localStorage.getItem('user')
          if (savedUser) {
            const userData = JSON.parse(savedUser)
            const currentUserId = userData.id || userData.userId

            if (currentUserId) {
              // æŸ¥è©¢ä½¿ç”¨è€…çš„ç¤¾ç¾¤åˆ—è¡¨ï¼Œæ‰¾åˆ°å°æ‡‰åç¨±çš„ç¤¾ç¾¤
              const response = await fetch(`/api/communities?userId=${currentUserId}`)
              const communities = await response.json()

              if (response.ok && Array.isArray(communities)) {
                const foundCommunity = communities.find((c: any) => c.name === communityName)
                if (foundCommunity) {
                  setCommunityId(foundCommunity.id)
                }
              }
            }
          }
        } catch (error) {
          console.error('æŸ¥è©¢ç¤¾ç¾¤IDå¤±æ•—:', error)
        }
      }
    }

    fetchCommunityId()
  }, [communityId, communityName])

  // è¼‰å…¥æ´»å‹•åˆ—è¡¨
  useEffect(() => {
    if (communityId) {
      loadActivities()
      loadResources()
      loadIdeas()
      loadKanban()
      loadCommunityMembers()
    }
  }, [communityId])

  // çµ„ä»¶å¸è¼‰æ™‚æ¸…ç†æ‰€æœ‰ timeout
  useEffect(() => {
    return () => {
      // æ¸…ç†æ‰€æœ‰ä½ç½®æ›´æ–°çš„ timeout
      positionUpdateTimeoutRef.current.forEach((timeout) => {
        clearTimeout(timeout)
      })
      positionUpdateTimeoutRef.current.clear()
      lastUpdatePositionRef.current.clear()
    }
  }, [])

  // è¼‰å…¥ç¤¾ç¾¤æˆå“¡åˆ—è¡¨
  const loadCommunityMembers = async () => {
    if (!communityId) return

    try {
      const response = await fetch(`/api/communities/${communityId}/members`)
      const data = await response.json()

      if (response.ok) {
        // è½‰æ›ç‚º AddTaskModal éœ€è¦çš„æ ¼å¼
        const members = data.map((member: any) => ({
          id: member.userId, // ä½¿ç”¨ userId ä½œç‚º id
          name: member.nickname, // ä½¿ç”¨ nickname ä½œç‚º name
          avatar: member.avatar || '',
        }))
        setCommunityMembers(members)
        
        // å„²å­˜å®Œæ•´çš„æˆå“¡è³‡æ–™ç”¨æ–¼ç¤¾ç¾¤ç®¡ç†é é¢
        setFullCommunityMembers(data)
      } else {
        console.error('è¼‰å…¥ç¤¾ç¾¤æˆå“¡åˆ—è¡¨å¤±æ•—:', data.error)
      }
    } catch (error) {
      console.error('è¼‰å…¥ç¤¾ç¾¤æˆå“¡åˆ—è¡¨éŒ¯èª¤:', error)
    }
  }

  // è¨­å®šæˆå“¡ç‚ºç®¡ç†å“¡æˆ–å–æ¶ˆç®¡ç†å“¡
  const handleToggleAdmin = async (targetUserId: string, isCurrentlyAdmin: boolean) => {
    if (!communityId || !userId) {
      alert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥')
      return
    }

    if (!confirm(`ç¢ºå®šè¦${isCurrentlyAdmin ? 'å–æ¶ˆ' : 'è¨­ç‚º'}ç®¡ç†å“¡å—ï¼Ÿ`)) {
      return
    }

    try {
      const response = await fetch(`/api/communities/${communityId}/members`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: targetUserId,
          role: isCurrentlyAdmin ? 'member' : 'admin',
          operatorId: userId,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'æ“ä½œå¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥æˆå“¡åˆ—è¡¨
      await loadCommunityMembers()
      alert(`å·²${isCurrentlyAdmin ? 'å–æ¶ˆ' : 'è¨­ç‚º'}ç®¡ç†å“¡`)
    } catch (error: any) {
      console.error('è¨­å®šç®¡ç†å“¡éŒ¯èª¤:', error)
      alert(error.message || 'æ“ä½œå¤±æ•—')
    }
  }

  // ç§»å‡ºç¤¾ç¾¤æˆå“¡
  const handleRemoveMember = async (targetUserId: string, targetUserName: string) => {
    if (!communityId || !userId) {
      alert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹é‡æ–°ç™»å…¥')
      return
    }

    if (!confirm(`ç¢ºå®šè¦å°‡ã€Œ${targetUserName}ã€ç§»å‡ºç¤¾ç¾¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
      return
    }

    try {
      const response = await fetch(
        `/api/communities/${communityId}/members?userId=${targetUserId}&operatorId=${userId}`,
        {
          method: 'DELETE',
        }
      )

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'ç§»å‡ºæˆå“¡å¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥æˆå“¡åˆ—è¡¨
      await loadCommunityMembers()
      alert('æˆå“¡å·²ç§»å‡ºç¤¾ç¾¤')
    } catch (error: any) {
      console.error('ç§»å‡ºæˆå“¡éŒ¯èª¤:', error)
      alert(error.message || 'ç§»å‡ºæˆå“¡å¤±æ•—')
    }
  }

  const loadActivities = async () => {
    if (!communityId) return

    try {
      const response = await fetch(`/api/communities/${communityId}/activities`)
      const data = await response.json()

      if (response.ok) {
        setActivities(data)
      } else {
        console.error('è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—:', data.error)
      }
    } catch (error) {
      console.error('è¼‰å…¥æ´»å‹•åˆ—è¡¨éŒ¯èª¤:', error)
    }
  }

  // é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰é¸å–®
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        dropdownRef.current &&
        avatarRef.current &&
        !dropdownRef.current.contains(event.target as Node) &&
        !avatarRef.current.contains(event.target as Node)
      ) {
        setIsDropdownOpen(false)
      }
    }

    if (isDropdownOpen) {
      document.addEventListener('mousedown', handleClickOutside)
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [isDropdownOpen])

  // é»æ“Šå¤–éƒ¨é—œé–‰æˆå“¡é¸å–®
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (openMemberMenuId) {
        const target = event.target as HTMLElement
        // å¦‚æœé»æ“Šçš„ä¸æ˜¯æˆå“¡é¸å–®ç›¸é—œçš„å…ƒç´ ï¼Œå‰‡é—œé–‰é¸å–®
        if (!target.closest('.member-menu-container')) {
          setOpenMemberMenuId(null)
        }
      }
    }

    if (openMemberMenuId) {
      // å»¶é²æ·»åŠ ç›£è½å™¨ï¼Œé¿å…ç«‹å³è§¸ç™¼
      const timeoutId = setTimeout(() => {
        document.addEventListener('mousedown', handleClickOutside)
      }, 0)

      return () => {
        clearTimeout(timeoutId)
        document.removeEventListener('mousedown', handleClickOutside)
      }
    }
  }, [openMemberMenuId])

  const handleAvatarClick = () => {
    setIsDropdownOpen(!isDropdownOpen)
  }

  const handleLogout = () => {
    // æ¸…é™¤ localStorage ä¸­çš„ä½¿ç”¨è€…è³‡æ–™
    if (typeof window !== 'undefined') {
      localStorage.removeItem('user')
      // é‡æ–°è¼‰å…¥é é¢ä»¥å›åˆ°ç™»å…¥ç•«é¢
      window.location.href = '/'
    }
    setIsDropdownOpen(false)
  }

  // ç¤¾ç¾¤æˆå“¡æ•¸æ“šï¼ˆå¾ API è¼‰å…¥ï¼‰
  const [communityMembers, setCommunityMembers] = useState<Array<{ id: string; name: string; avatar?: string }>>([]
  )
  
  // å®Œæ•´çš„ç¤¾ç¾¤æˆå“¡è³‡æ–™ï¼ˆç”¨æ–¼ç¤¾ç¾¤ç®¡ç†é é¢ï¼‰
  const [fullCommunityMembers, setFullCommunityMembers] = useState<Array<{ 
    id: string
    userId: string
    nickname: string
    account: string
    email: string
    school: string
    role: string
  }>>([])

  const tabs = [
    { id: 'resources' as TabType, label: 'è³‡æº', icon: 'ğŸ“' },
    { id: 'activities' as TabType, label: 'å…±å‚™æ´»å‹•', icon: 'ğŸ“' },
    { id: 'ideas' as TabType, label: 'æƒ³æ³•ç‰†', icon: 'ğŸ’¡' },
    { id: 'teamwork' as TabType, label: 'åœ˜éšŠåˆ†å·¥', icon: 'ğŸ¯' },
    { id: 'history' as TabType, label: 'æ´»å‹•æ­·ç¨‹', icon: 'ğŸ“„' },
    { id: 'management' as TabType, label: 'ç¤¾ç¾¤ç®¡ç†', icon: 'ğŸ‘¥' },
  ]

  const handleAddFileClick = () => {
    fileInputRef.current?.click()
  }

  const loadResources = async () => {
    if (!communityId) return

    try {
      const response = await fetch(`/api/communities/${communityId}/resources`)
      const data = await response.json()

      if (response.ok) {
        setResources(data)
      } else {
        console.error('è¼‰å…¥è³‡æºåˆ—è¡¨å¤±æ•—:', data.error)
      }
    } catch (error) {
      console.error('è¼‰å…¥è³‡æºåˆ—è¡¨éŒ¯èª¤:', error)
    }
  }

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    
    // è©³ç´°é©—è­‰
    if (!file) {
      alert('è«‹é¸æ“‡æª”æ¡ˆ')
      return
    }
    
    if (!communityId) {
      console.error('communityId ç‚ºç©º:', { communityId, propCommunityId, communityName })
      alert('ç¤¾ç¾¤IDä¸å­˜åœ¨ï¼Œè«‹é‡æ–°é€²å…¥ç¤¾ç¾¤é é¢')
      return
    }
    
    if (!userId) {
      alert('è«‹å…ˆç™»å…¥')
      return
    }

    try {
      // ä½¿ç”¨ FormData ä¸Šå‚³æª”æ¡ˆ
      const formData = new FormData()
      formData.append('file', file)
      formData.append('uploadedBy', userId)

      const apiUrl = `/api/communities/${communityId}/resources`
      console.log('ä¸Šå‚³æª”æ¡ˆåˆ°:', apiUrl, { communityId, userId, fileName: file.name })

      const response = await fetch(apiUrl, {
        method: 'POST',
        body: formData,
      })

      const data = await response.json()

      if (!response.ok) {
        const errorMessage = data.details 
          ? `${data.error}: ${data.details}` 
          : data.error || 'ä¸Šå‚³è³‡æºå¤±æ•—'
        throw new Error(errorMessage)
      }

      // é‡æ–°è¼‰å…¥è³‡æºåˆ—è¡¨
      await loadResources()
      alert('æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼')
    } catch (error: any) {
      console.error('ä¸Šå‚³æª”æ¡ˆéŒ¯èª¤:', error)
      alert(error.message || 'ä¸Šå‚³æª”æ¡ˆå¤±æ•—')
    }

    // é‡ç½® inputï¼Œé€™æ¨£å¯ä»¥é¸æ“‡åŒä¸€å€‹æª”æ¡ˆ
    if (fileInputRef.current) {
      fileInputRef.current.value = ''
    }
  }

  const handleDeleteResource = async (resourceId: string) => {
    if (!communityId) {
      alert('ç¤¾ç¾¤è³‡è¨ŠéŒ¯èª¤')
      return
    }

    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³‡æºå—ï¼Ÿ')) {
      return
    }

    try {
      const response = await fetch(
        `/api/communities/${communityId}/resources?resourceId=${resourceId}`,
        {
          method: 'DELETE',
        }
      )

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'åˆªé™¤è³‡æºå¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥è³‡æºåˆ—è¡¨
      await loadResources()
      alert('è³‡æºå·²åˆªé™¤')
    } catch (error: any) {
      console.error('åˆªé™¤è³‡æºéŒ¯èª¤:', error)
      alert(error.message || 'åˆªé™¤è³‡æºå¤±æ•—')
    }
  }

  const handleDownloadResource = async (resourceId: string) => {
    if (!communityId) {
      alert('ç¤¾ç¾¤è³‡è¨ŠéŒ¯èª¤')
      return
    }

    try {
      const response = await fetch(`/api/communities/${communityId}/resources/${resourceId}/download`)
      
      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || 'ä¸‹è¼‰è³‡æºå¤±æ•—')
      }

      // ç²å–æª”æ¡ˆåç¨±
      const contentDisposition = response.headers.get('Content-Disposition')
      let fileName = 'download'
      if (contentDisposition) {
        const fileNameMatch = contentDisposition.match(/filename="?(.+?)"?$/i)
        if (fileNameMatch) {
          fileName = decodeURIComponent(fileNameMatch[1])
        }
      }

      // å°‡å›æ‡‰è½‰æ›ç‚º Blob
      const blob = await response.blob()
      
      // å‰µå»ºä¸‹è¼‰é€£çµ
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = fileName
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      window.URL.revokeObjectURL(url)
    } catch (error: any) {
      console.error('ä¸‹è¼‰è³‡æºéŒ¯èª¤:', error)
      alert(error.message || 'ä¸‹è¼‰è³‡æºå¤±æ•—')
    }
  }

  const handleCloseAddActivityModal = () => {
    setIsAddActivityModalOpen(false)
    setEditingActivity(null) // æ¸…é™¤ç·¨è¼¯ç‹€æ…‹
  }

  const handleAddActivity = async (activityData: {
    name: string
    isPublic: boolean
    password: string
    introduction: string
  }) => {
    if (!communityId || !userId) {
      alert('è«‹å…ˆç™»å…¥ä¸¦ç¢ºä¿ç¤¾ç¾¤è³‡è¨Šæ­£ç¢º')
      return
    }

    try {
      if (editingActivity) {
        // ç·¨è¼¯æ¨¡å¼ï¼šæ›´æ–°ç¾æœ‰æ´»å‹•
        const response = await fetch(`/api/activities/${editingActivity.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: activityData.name,
            introduction: activityData.introduction,
            isPublic: activityData.isPublic,
            password: activityData.password,
            userId,
          }),
        })

        const data = await response.json()

        if (!response.ok) {
          throw new Error(data.error || 'æ›´æ–°æ´»å‹•å¤±æ•—')
        }

        // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
        await loadActivities()
        alert('ä¿®æ”¹æ´»å‹•æˆåŠŸï¼')
      } else {
        // æ–°å¢æ¨¡å¼ï¼šå‰µå»ºæ–°æ´»å‹•
        const response = await fetch(`/api/communities/${communityId}/activities`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: activityData.name,
            introduction: activityData.introduction,
            isPublic: activityData.isPublic,
            password: activityData.password,
            creatorId: userId,
          }),
        })

        const data = await response.json()

        if (!response.ok) {
          throw new Error(data.error || 'å»ºç«‹æ´»å‹•å¤±æ•—')
        }

        // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
        await loadActivities()
        alert('å»ºç«‹æ´»å‹•æˆåŠŸï¼')
      }

      setIsAddActivityModalOpen(false)
      setEditingActivity(null) // æ¸…é™¤ç·¨è¼¯ç‹€æ…‹
    } catch (error: any) {
      console.error('æ“ä½œæ´»å‹•éŒ¯èª¤:', error)
      alert(error.message || 'æ“ä½œå¤±æ•—')
    }
  }

  const handleEditActivity = (activityId: string) => {
    const activity = activities.find((a) => a.id === activityId)
    if (activity) {
      setEditingActivity(activity) // è¨­ç½®è¦ç·¨è¼¯çš„æ´»å‹•
      setIsAddActivityModalOpen(true) // æ‰“é–‹æ¨¡æ…‹æ¡†
    }
  }

  const handleRequestPassword = (activityId: string, action: 'edit' | 'view' | 'menu') => {
    const activity = activities.find((a) => a.id === activityId)
    if (activity) {
      setPasswordVerifyingActivity(activity)
      setPasswordAction(action)
      setIsPasswordModalOpen(true)
    }
  }

  const handlePasswordVerify = (password: string): boolean => {
    if (!passwordVerifyingActivity) return false
    const isValid = password === passwordVerifyingActivity.password
    if (isValid) {
      // å¯†ç¢¼æ­£ç¢ºï¼Œå°‡æ´»å‹• ID åŠ å…¥å·²é©—è­‰é›†åˆï¼ˆä¿æŒé©—è­‰ç‹€æ…‹ï¼‰
      setPasswordVerifiedActivityIds((prev) => {
        const newSet = new Set(prev)
        newSet.add(passwordVerifyingActivity.id)
        return newSet
      })
      
      // æ ¹æ“š action åŸ·è¡Œç›¸æ‡‰æ“ä½œ
      if (passwordAction === 'menu') {
        // å¦‚æœæ˜¯é¸å–®ï¼Œæ¨™è¨˜ç‚ºå·²é©—è­‰ï¼Œé¸å–®æœƒåœ¨ ActivityCard ä¸­è‡ªå‹•æ‰“é–‹
        // é©—è­‰ç‹€æ…‹å·²ç¶“åœ¨ä¸Šé¢è¨­ç½®äº†
      } else if (passwordAction === 'edit') {
        // å¦‚æœæ˜¯ç·¨è¼¯ï¼Œæ‰“é–‹ç·¨è¼¯æ¨¡æ…‹æ¡†
        setEditingActivity(passwordVerifyingActivity)
        setIsAddActivityModalOpen(true)
      } else {
        // å¦‚æœæ˜¯æŸ¥çœ‹ï¼Œé€²å…¥æ´»å‹•ç•«é¢
        setViewingActivity(passwordVerifyingActivity)
      }
      setIsPasswordModalOpen(false)
      setPasswordVerifyingActivity(null)
    }
    return isValid
  }

  const handleClosePasswordModal = () => {
    setIsPasswordModalOpen(false)
    setPasswordVerifyingActivity(null)
  }

  const handleBackFromActivity = () => {
    setViewingActivity(null)
  }

  const handleSidebarClickFromActivity = (tabId: string) => {
    setViewingActivity(null)
    setActiveTab(tabId as TabType)
  }

  const handleCardClick = (activityId: string) => {
    const activity = activities.find((a) => a.id === activityId)
    if (activity) {
      // å¦‚æœæ²’æœ‰å¯†ç¢¼ï¼Œç›´æ¥é€²å…¥æ´»å‹•ç•«é¢
      // å¦‚æœæœ‰å¯†ç¢¼ä½†å·²ç¶“é©—è­‰éï¼Œä¹Ÿé€²å…¥æ´»å‹•ç•«é¢
      const hasPassword = activity.password && activity.password.trim()
      const isVerified = passwordVerifiedActivityIds.has(activityId)
      
      if (!hasPassword || isVerified) {
        setViewingActivity(activity)
      }
      // å¦‚æœæœ‰å¯†ç¢¼ä¸”æœªé©—è­‰ï¼Œæœƒç”± ActivityCard è§¸ç™¼å¯†ç¢¼é©—è­‰
    }
  }

  const handleManageVersion = (activityId: string) => {
    setVersionControlActivityId(activityId)
    setIsVersionControlModalOpen(true)
  }

  const handleCloseVersionControlModal = () => {
    setIsVersionControlModalOpen(false)
    setVersionControlActivityId(null)
  }

  const handleRestoreVersion = async (versionId: string) => {
    if (!versionControlActivityId || !userId) {
      alert('è«‹å…ˆç™»å…¥ä¸¦ç¢ºä¿æ´»å‹•è³‡è¨Šæ­£ç¢º')
      return
    }

    if (!confirm('ç¢ºå®šè¦å›å¾©åˆ°æ­¤ç‰ˆæœ¬å—ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„æ•™æ¡ˆå…§å®¹ã€‚')) {
      return
    }

    try {
      const response = await fetch(`/api/activity-versions/${versionControlActivityId}/restore`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          versionId,
          userId,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'å›è¦†ç‰ˆæœ¬å¤±æ•—')
      }

      alert('ç‰ˆæœ¬å·²å›è¦†ï¼')
      setIsVersionControlModalOpen(false)
      // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„è³‡æ–™
      await loadActivities()
    } catch (error: any) {
      console.error('å›è¦†ç‰ˆæœ¬éŒ¯èª¤:', error)
      alert(error.message || 'å›è¦†ç‰ˆæœ¬å¤±æ•—')
    }
  }

  const handleDeleteActivity = async (activityId: string) => {
    if (!userId) {
      alert('è«‹å…ˆç™»å…¥')
      return
    }

    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
      return
    }

    try {
      const response = await fetch(`/api/activities/${activityId}?userId=${userId}`, {
        method: 'DELETE',
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'åˆªé™¤æ´»å‹•å¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
      await loadActivities()
      alert('æ´»å‹•å·²åˆªé™¤')
    } catch (error: any) {
      console.error('åˆªé™¤æ´»å‹•éŒ¯èª¤:', error)
      alert(error.message || 'åˆªé™¤æ´»å‹•å¤±æ•—')
    }
  }

  const loadKanban = async () => {
    if (!communityId) return

    try {
      const response = await fetch(`/api/communities/${communityId}/kanban`)
      const data = await response.json()

      if (response.ok) {
        // å¦‚æœæ²’æœ‰åˆ—è¡¨ä¸”è©²ç¤¾ç¾¤å°šæœªåˆå§‹åŒ–ï¼Œå»ºç«‹é è¨­çš„ä¸‰å€‹åˆ—è¡¨
        if (Array.isArray(data) && data.length === 0 && !kanbanInitializedRef.current.has(communityId)) {
          kanbanInitializedRef.current.add(communityId) // æ¨™è¨˜ç‚ºå·²åˆå§‹åŒ–
          
          const defaultLists = [
            { title: 'å¾…è™•ç†' },
            { title: 'é€²è¡Œä¸­' },
            { title: 'å·²å®Œæˆ' },
          ]

          // ä¾åºå»ºç«‹é è¨­åˆ—è¡¨
          for (const list of defaultLists) {
            try {
              const createResponse = await fetch(`/api/communities/${communityId}/kanban`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  type: 'list',
                  title: list.title,
                }),
              })

              if (!createResponse.ok) {
                console.error('å»ºç«‹é è¨­åˆ—è¡¨å¤±æ•—:', list.title)
              }
            } catch (error) {
              console.error('å»ºç«‹é è¨­åˆ—è¡¨éŒ¯èª¤:', error)
            }
          }

          // é‡æ–°è¼‰å…¥åˆ—è¡¨
          const reloadResponse = await fetch(`/api/communities/${communityId}/kanban`)
          const reloadData = await reloadResponse.json()
          if (reloadResponse.ok) {
            setKanbanLists(reloadData)
          }
        } else {
          // å¦‚æœå·²æœ‰åˆ—è¡¨ï¼Œä¹Ÿæ¨™è¨˜ç‚ºå·²åˆå§‹åŒ–
          if (Array.isArray(data) && data.length > 0) {
            kanbanInitializedRef.current.add(communityId)
          }
          setKanbanLists(data)
        }
      } else {
        console.error('è¼‰å…¥ Kanban è³‡æ–™å¤±æ•—:', data.error)
      }
    } catch (error) {
      console.error('è¼‰å…¥ Kanban è³‡æ–™éŒ¯èª¤:', error)
    }
  }

  // åœ˜éšŠåˆ†å·¥ç›¸é—œè™•ç†å‡½æ•¸
  const handleAddList = async () => {
    if (!communityId) {
      alert('ç¤¾ç¾¤è³‡è¨ŠéŒ¯èª¤')
      return
    }

    if (!newListTitle.trim()) {
      return
    }

    try {
      const response = await fetch(`/api/communities/${communityId}/kanban`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type: 'list',
          title: newListTitle.trim(),
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'å»ºç«‹åˆ—è¡¨å¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥ Kanban è³‡æ–™
      await loadKanban()
      setNewListTitle('')
      setIsAddingList(false)
    } catch (error: any) {
      console.error('å»ºç«‹åˆ—è¡¨éŒ¯èª¤:', error)
      alert(error.message || 'å»ºç«‹åˆ—è¡¨å¤±æ•—')
    }
  }

  const handleDeleteList = async (listId: string) => {
    if (!communityId) {
      alert('ç¤¾ç¾¤è³‡è¨ŠéŒ¯èª¤')
      return
    }

    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åˆ—è¡¨å—ï¼Ÿæ­¤æ“ä½œæœƒåˆªé™¤åˆ—è¡¨ä¸­çš„æ‰€æœ‰ä»»å‹™ã€‚')) {
      return
    }

    try {
      const response = await fetch(
        `/api/communities/${communityId}/kanban?type=list&id=${listId}`,
        {
          method: 'DELETE',
        }
      )

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'åˆªé™¤åˆ—è¡¨å¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥ Kanban è³‡æ–™
      await loadKanban()
      alert('åˆ—è¡¨å·²åˆªé™¤')
    } catch (error: any) {
      console.error('åˆªé™¤åˆ—è¡¨éŒ¯èª¤:', error)
      alert(error.message || 'åˆªé™¤åˆ—è¡¨å¤±æ•—')
    }
  }

  const handleAddTask = (listId: string) => {
    // é©—è­‰ listId æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ UUIDï¼ˆä¸æ˜¯ç¡¬ç·¨ç¢¼çš„ '1', '2', '3'ï¼‰
    if (!listId || listId === '1' || listId === '2' || listId === '3' || listId.length < 30) {
      console.error('ç„¡æ•ˆçš„åˆ—è¡¨ID:', listId)
      alert('åˆ—è¡¨IDç„¡æ•ˆï¼Œè«‹é‡æ–°è¼‰å…¥é é¢')
      return
    }
    
    // ç¢ºèªåˆ—è¡¨å­˜åœ¨æ–¼ç•¶å‰è¼‰å…¥çš„åˆ—è¡¨ä¸­
    const listExists = kanbanLists.some(list => list.id === listId)
    if (!listExists) {
      console.error('åˆ—è¡¨ä¸å­˜åœ¨æ–¼ç•¶å‰è¼‰å…¥çš„åˆ—è¡¨ä¸­:', listId, kanbanLists)
      alert('åˆ—è¡¨ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢')
      return
    }
    
    setCurrentListId(listId)
    setIsAddTaskModalOpen(true)
  }

  const handleSubmitTask = async (task: {
    category: string
    content: string
    startDate: string
    endDate: string
    assignees: string[] // é€™è£¡æ˜¯ä½¿ç”¨è€…IDé™£åˆ—ï¼ˆå¾ AddTaskModal å‚³å…¥ï¼‰
  }) => {
    if (!communityId) {
      alert('ç¤¾ç¾¤è³‡è¨ŠéŒ¯èª¤')
      return
    }

    try {
      // assignees å·²ç¶“æ˜¯ä½¿ç”¨è€…IDé™£åˆ—ï¼ˆå¾ AddTaskModal å‚³å…¥çš„ member.idï¼‰
      // ä¸éœ€è¦è½‰æ›ï¼Œç›´æ¥ä½¿ç”¨
      const assigneeIds = task.assignees || []

      if (editingTask) {
        // ç·¨è¼¯ä»»å‹™
        const response = await fetch(`/api/communities/${communityId}/kanban`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'task',
            id: editingTask.taskId,
            title: task.category,
            content: task.content,
            startDate: task.startDate,
            endDate: task.endDate,
            assignees: assigneeIds, // ä½¿ç”¨è€…IDé™£åˆ—
          }),
        })

        const data = await response.json()

        if (!response.ok) {
          throw new Error(data.error || 'æ›´æ–°ä»»å‹™å¤±æ•—')
        }

        // é‡æ–°è¼‰å…¥ Kanban è³‡æ–™
        await loadKanban()
        setEditingTask(null)
        alert('æ›´æ–°ä»»å‹™æˆåŠŸï¼')
      } else {
        // æ–°å¢ä»»å‹™
        if (!currentListId) {
          alert('è«‹é¸æ“‡è¦æ–°å¢ä»»å‹™çš„åˆ—è¡¨')
          return
        }

        // å†æ¬¡é©—è­‰ currentListId æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ UUID
        if (currentListId === '1' || currentListId === '2' || currentListId === '3' || currentListId.length < 30) {
          console.error('ç„¡æ•ˆçš„åˆ—è¡¨ID:', currentListId)
          alert('åˆ—è¡¨IDç„¡æ•ˆï¼Œè«‹é‡æ–°è¼‰å…¥é é¢å¾Œå†è©¦')
          return
        }

        // ç¢ºèªåˆ—è¡¨å­˜åœ¨æ–¼ç•¶å‰è¼‰å…¥çš„åˆ—è¡¨ä¸­
        const listExists = kanbanLists.some(list => list.id === currentListId)
        if (!listExists) {
          console.error('åˆ—è¡¨ä¸å­˜åœ¨æ–¼ç•¶å‰è¼‰å…¥çš„åˆ—è¡¨ä¸­:', currentListId, kanbanLists)
          alert('åˆ—è¡¨ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢å¾Œå†è©¦')
          return
        }

        console.log('æ–°å¢ä»»å‹™:', { communityId, currentListId, task, assigneeIds, kanbanLists })

        const response = await fetch(`/api/communities/${communityId}/kanban`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'task',
            listId: currentListId,
            title: task.category || '',
            content: task.content || '',
            startDate: task.startDate || null,
            endDate: task.endDate || null,
            assignees: assigneeIds, // ä½¿ç”¨è€…IDé™£åˆ—
            creatorId: userId, // æ·»åŠ å‰µå»ºè€…ID
          }),
        })

        const data = await response.json()

        if (!response.ok) {
          const errorMessage = data.details 
            ? `${data.error}: ${data.details}` 
            : data.error || 'å»ºç«‹ä»»å‹™å¤±æ•—'
          console.error('å»ºç«‹ä»»å‹™å¤±æ•—:', { response: data, status: response.status })
          throw new Error(errorMessage)
        }

        // é‡æ–°è¼‰å…¥ Kanban è³‡æ–™
        await loadKanban()
        alert('å»ºç«‹ä»»å‹™æˆåŠŸï¼')
      }

      setIsAddTaskModalOpen(false)
    } catch (error: any) {
      console.error('æ“ä½œä»»å‹™éŒ¯èª¤:', error)
      alert(error.message || 'æ“ä½œå¤±æ•—')
    }
  }

  const loadIdeas = async () => {
    if (!communityId) return

    try {
      const response = await fetch(`/api/communities/${communityId}/ideas`)
      const data = await response.json()

      if (response.ok) {
        setIdeas(data)
      } else {
        console.error('è¼‰å…¥æƒ³æ³•åˆ—è¡¨å¤±æ•—:', data.error)
      }
    } catch (error) {
      console.error('è¼‰å…¥æƒ³æ³•åˆ—è¡¨éŒ¯èª¤:', error)
    }
  }

  const handleAddIdea = async (ideaData: {
    activityId?: string
    stage: string
    title: string
    content: string
  }) => {
    if (!communityId || !userId) {
      alert('è«‹å…ˆç™»å…¥ä¸¦ç¢ºä¿ç¤¾ç¾¤è³‡è¨Šæ­£ç¢º')
      return
    }

    try {
      // è¨ˆç®—åˆå§‹ä½ç½®
      let initialPosition = { x: 50, y: 50 }
      let initialRotation = 0

      if (extendingFromIdeaId) {
        // å¦‚æœæ˜¯å»¶ä¼¸æƒ³æ³•ï¼Œæ”¾åœ¨çˆ¶ç¯€é»çš„å³å´
        const parentIdea = ideas.find((i) => i.id === extendingFromIdeaId)
        if (parentIdea && parentIdea.position) {
          initialPosition = {
            x: parentIdea.position.x + 150, // çˆ¶ç¯€é»å³å´ 150px
            y: parentIdea.position.y,
          }
          initialRotation = parentIdea.rotation || 0 // ç¹¼æ‰¿çˆ¶ç¯€é»çš„æ—‹è½‰è§’åº¦
        }
      } else {
        // å¦‚æœæ˜¯æ–°æƒ³æ³•ï¼ŒæŒ‰é †åºæ’åˆ—
        const existingIdeasCount = ideas.filter((i) => !i.parentId).length
        const row = Math.floor(existingIdeasCount / 4)
        const col = existingIdeasCount % 4
        initialPosition = {
          x: 50 + col * 200,
          y: 50 + row * 150,
        }
      }

      const response = await fetch(`/api/communities/${communityId}/ideas`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          activityId: ideaData.activityId || null,
          stage: ideaData.stage,
          title: ideaData.title,
          content: ideaData.content,
          parentId: extendingFromIdeaId || null,
          position: initialPosition,
          rotation: initialRotation,
          isConvergence: false,
          convergedIdeaIds: null,
          creatorId: userId,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'å»ºç«‹æƒ³æ³•å¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥æƒ³æ³•åˆ—è¡¨
      await loadIdeas()
      setIsAddIdeaModalOpen(false)
      setExtendingFromIdeaId(null) // æ¸…é™¤å»¶ä¼¸ä¾†æº
      alert('å»ºç«‹æƒ³æ³•æˆåŠŸï¼')
    } catch (error: any) {
      console.error('å»ºç«‹æƒ³æ³•éŒ¯èª¤:', error)
      alert(error.message || 'å»ºç«‹æƒ³æ³•å¤±æ•—')
    }
  }

  const handleEditIdea = (ideaId: string) => {
    const idea = ideas.find((i) => i.id === ideaId)
    if (idea) {
      setEditingIdea(idea)
      setIsEditIdeaModalOpen(true)
    }
  }

  const handleSaveIdea = async (ideaData: {
    stage: string
    title: string
    content: string
  }) => {
    if (!editingIdea || !userId) {
      alert('è«‹å…ˆç™»å…¥')
      return
    }

    try {
      const response = await fetch(`/api/ideas/${editingIdea.id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          activityId: ideaData.activityId || null,
          stage: ideaData.stage,
          title: ideaData.title,
          content: ideaData.content,
          position: editingIdea.position,
          rotation: editingIdea.rotation,
          userId,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'æ›´æ–°æƒ³æ³•å¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥æƒ³æ³•åˆ—è¡¨
      await loadIdeas()
      setEditingIdea(null)
      setIsEditIdeaModalOpen(false)
      alert('æ›´æ–°æƒ³æ³•æˆåŠŸï¼')
    } catch (error: any) {
      console.error('æ›´æ–°æƒ³æ³•éŒ¯èª¤:', error)
      alert(error.message || 'æ›´æ–°æƒ³æ³•å¤±æ•—')
    }
  }

  const handleDeleteIdea = async () => {
    if (!editingIdea || !userId) {
      alert('è«‹å…ˆç™»å…¥')
      return
    }

    // ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿç¢ºèªå°è©±æ¡†
    if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æƒ³æ³•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
      try {
        const response = await fetch(`/api/ideas/${editingIdea.id}?userId=${userId}`, {
          method: 'DELETE',
        })

        const data = await response.json()

        if (!response.ok) {
          throw new Error(data.error || 'åˆªé™¤æƒ³æ³•å¤±æ•—')
        }

        // é‡æ–°è¼‰å…¥æƒ³æ³•åˆ—è¡¨
        await loadIdeas()
        setEditingIdea(null)
        setIsEditIdeaModalOpen(false)
        alert('æƒ³æ³•å·²åˆªé™¤')
      } catch (error: any) {
        console.error('åˆªé™¤æƒ³æ³•éŒ¯èª¤:', error)
        alert(error.message || 'åˆªé™¤æƒ³æ³•å¤±æ•—')
      }
    }
  }

  const handleExtendIdea = () => {
    if (editingIdea) {
      console.log('å»¶ä¼¸æƒ³æ³•:', editingIdea.id)
      // TODO: å¯¦ä½œå»¶ä¼¸æƒ³æ³•çš„ API é‚è¼¯
      
      // è¨­ç½®å»¶ä¼¸ä¾†æº IDï¼Œç„¶å¾Œæ‰“é–‹æ–°å¢æƒ³æ³•æ¨¡æ…‹æ¡†
      setExtendingFromIdeaId(editingIdea.id)
      setIsEditIdeaModalOpen(false)
      setEditingIdea(null)
      setIsAddIdeaModalOpen(true)
    }
  }

  const handleCloseEditIdeaModal = () => {
    setIsEditIdeaModalOpen(false)
    setEditingIdea(null)
  }

  const handleConvergenceSubmit = async (data: {
    activityId?: string
    stage: string
    selectedIdeaIds: string[]
    convergenceContent: string
    comments: { content: string; author: string; createdAt: string }[]
  }) => {
    if (!communityId || !userId) {
      alert('è«‹å…ˆç™»å…¥ä¸¦ç¢ºä¿ç¤¾ç¾¤è³‡è¨Šæ­£ç¢º')
      return
    }

    try {
      // è¨ˆç®—æ”¶æ–‚ç¯€é»çš„ä½ç½®ï¼ˆæ”¾åœ¨è¢«æ”¶æ–‚ç¯€é»çš„å³å´ï¼‰
      const convergedIdeas = ideas.filter(idea => data.selectedIdeaIds.includes(idea.id))
      let convergencePosition = { x: 0, y: 0 }

      if (convergedIdeas.length > 0) {
        // æ‰¾å‡ºæ‰€æœ‰è¢«æ”¶æ–‚ç¯€é»ä¸­æœ€å³é‚Šçš„ä½ç½®
        const maxX = Math.max(...convergedIdeas.map(idea => idea.position?.x || 0))
        convergencePosition = { x: maxX + 250, y: 100 }
      }

      const response = await fetch(`/api/communities/${communityId}/ideas`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          activityId: data.activityId || null,
          stage: data.stage,
          title: 'æ”¶æ–‚çµæœ',
          content: data.convergenceContent || '(å°šæœªå¡«å¯«æ”¶æ–‚å…§å®¹)',
          parentId: null,
          position: convergencePosition,
          rotation: 0,
          isConvergence: true,
          convergedIdeaIds: data.selectedIdeaIds,
          creatorId: userId,
        }),
      })

      const apiData = await response.json()

      if (!response.ok) {
        throw new Error(apiData.error || 'å»ºç«‹æ”¶æ–‚çµæœå¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥æƒ³æ³•åˆ—è¡¨
      await loadIdeas()
      setIsConvergenceModalOpen(false)
      alert(`å·²æ”¶æ–‚ ${data.selectedIdeaIds.length} å€‹æƒ³æ³•ç¯€é»`)
    } catch (error: any) {
      console.error('æ”¶æ–‚æƒ³æ³•éŒ¯èª¤:', error)
      alert(error.message || 'æ”¶æ–‚æƒ³æ³•å¤±æ•—')
    }
  }

  const handleIdeaPositionChange = async (ideaId: string, position: { x: number; y: number }) => {
    if (!userId || !userAccount) return

    // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦ç‚ºæƒ³æ³•çš„å»ºç«‹è€…
    const idea = ideas.find((i) => i.id === ideaId)
    if (!idea) return

    // æ¯”è¼ƒå»ºç«‹è€…å¸³è™Ÿå’Œç•¶å‰ä½¿ç”¨è€…å¸³è™Ÿ
    if (idea.creatorAccount && idea.creatorAccount !== userAccount) {
      // ä¸æ˜¯å»ºç«‹è€…ï¼Œä¸å…è¨±ç§»å‹•ï¼Œæ¢å¾©åˆ°åŸå§‹ä½ç½®
      const originalIdea = ideas.find((i) => i.id === ideaId)
      if (originalIdea && originalIdea.position) {
        setIdeas((prev) =>
          prev.map((idea) =>
            idea.id === ideaId ? { ...idea, position: originalIdea.position } : idea
          )
        )
      }
      return // éœé»˜è¿”å›ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    }

    // é™åˆ¶å¡ç‰‡ä¸èƒ½ç§»å‹•åˆ°é‚Šç•Œç·šä¸Šæ–¹ï¼ˆy ä¸èƒ½å°æ–¼ 0ï¼‰
    const constrainedPosition = {
      x: position.x,
      y: Math.max(0, position.y)
    }

    // å…ˆæ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼ˆå³æ™‚åé¥‹ï¼‰
    setIdeas((prev) =>
      prev.map((idea) =>
        idea.id === ideaId ? { ...idea, position: constrainedPosition } : idea
      )
    )

    // æ¸…é™¤ä¹‹å‰çš„ç¯€æµè¨ˆæ™‚å™¨
    const existingTimeout = positionUpdateTimeoutRef.current.get(ideaId)
    if (existingTimeout) {
      clearTimeout(existingTimeout)
    }

    // è¨˜éŒ„ç•¶å‰ä½ç½®
    lastUpdatePositionRef.current.set(ideaId, constrainedPosition)

    // è¨­ç½®ç¯€æµï¼š300ms å¾Œæ‰ç™¼é€ API è«‹æ±‚
    const timeoutId = setTimeout(async () => {
      try {
        const lastPosition = lastUpdatePositionRef.current.get(ideaId)
        if (!lastPosition) return

        const response = await fetch(`/api/ideas/${ideaId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            position: lastPosition,
            rotation: idea.rotation || 0,
            userId,
          }),
        })

        const data = await response.json()

        if (!response.ok) {
          // 403 æ¬Šé™éŒ¯èª¤æ™‚éœé»˜è™•ç†ï¼ˆä¸é¡¯ç¤ºéŒ¯èª¤ï¼‰
          if (response.status === 403) {
            // éœé»˜è™•ç†ï¼Œä¸è¨˜éŒ„éŒ¯èª¤
            // æ¢å¾©åˆ°æœ€å¾Œå·²çŸ¥çš„æœ‰æ•ˆä½ç½®
            await loadIdeas()
            return
          }
          
          // å…¶ä»–éŒ¯èª¤ï¼šåªæœ‰ç•¶ä¸æ˜¯å¸¸è¦‹çš„ç¶²çµ¡éŒ¯èª¤æ™‚æ‰è¨˜éŒ„
          // é¿å…åœ¨æ­£å¸¸æ“ä½œä¸­é¡¯ç¤ºéå¤šéŒ¯èª¤è¨Šæ¯
          if (response.status !== 404 && response.status !== 500) {
            console.warn('æ›´æ–°æƒ³æ³•ä½ç½®å¤±æ•—:', data.error || 'æœªçŸ¥éŒ¯èª¤')
          }
          // æ¢å¾©åˆ°æœ€å¾Œå·²çŸ¥çš„æœ‰æ•ˆä½ç½®
          await loadIdeas()
          return
        }

        // æ¸…é™¤è¨˜éŒ„
        lastUpdatePositionRef.current.delete(ideaId)
      } catch (error) {
        console.error('æ›´æ–°æƒ³æ³•ä½ç½®éŒ¯èª¤:', error)
        // å¦‚æœå¤±æ•—ï¼Œé‡æ–°è¼‰å…¥æƒ³æ³•åˆ—è¡¨ä»¥æ¢å¾©æ­£ç¢ºä½ç½®
        await loadIdeas()
      } finally {
        positionUpdateTimeoutRef.current.delete(ideaId)
      }
    }, 300) // 300ms ç¯€æµ

    positionUpdateTimeoutRef.current.set(ideaId, timeoutId)
  }

  const handleIdeaRotationChange = async (ideaId: string, rotation: number) => {
    if (!userId) return

    // å…ˆæ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼ˆå³æ™‚åé¥‹ï¼‰
    setIdeas((prev) =>
      prev.map((idea) =>
        idea.id === ideaId ? { ...idea, rotation } : idea
      )
    )

    // åŒæ­¥åˆ°è³‡æ–™åº«
    try {
      const idea = ideas.find((i) => i.id === ideaId)
      if (idea) {
        await fetch(`/api/ideas/${ideaId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            position: idea.position || { x: 50, y: 50 },
            rotation,
            userId,
          }),
        })
      }
    } catch (error) {
      console.error('æ›´æ–°æƒ³æ³•æ—‹è½‰éŒ¯èª¤:', error)
      // å¦‚æœå¤±æ•—ï¼Œé‡æ–°è¼‰å…¥æƒ³æ³•åˆ—è¡¨
      await loadIdeas()
    }
  }

  const handleEditTask = (taskId: string, listId: string) => {
    const list = kanbanLists.find((l) => l.id === listId)
    const task = list?.tasks.find((t) => t.id === taskId)
    
    if (task) {
      // å°‡ assigneesï¼ˆæš±ç¨±é™£åˆ—ï¼‰è½‰æ›ç‚ºä½¿ç”¨è€…IDé™£åˆ—
      const assigneeIds = task.assignees.map((nickname: string) => {
        // æ ¹æ“šæš±ç¨±æ‰¾åˆ°å°æ‡‰çš„ä½¿ç”¨è€…ID
        const member = communityMembers.find((m) => m.name === nickname)
        return member ? member.id : null
      }).filter((id: string | null) => id !== null) as string[]

      setEditingTask({ taskId, listId })
      setCurrentListId(listId)
      setIsAddTaskModalOpen(true)
      setOpenTaskMenuId(null)
      
      // æ³¨æ„ï¼šé€™è£¡éœ€è¦ç­‰å¾…æ¨¡æ…‹æ¡†æ‰“é–‹å¾Œå†è¨­ç½® initialData
      // ä½†ç”±æ–¼ AddTaskModal å·²ç¶“æœ‰ useEffect è™•ç† initialDataï¼Œæˆ‘å€‘éœ€è¦åœ¨é€™è£¡è¨­ç½®
      // å¯¦éš›ä¸Šï¼Œæˆ‘å€‘éœ€è¦ä¿®æ”¹ AddTaskModal çš„ props ä¾†å‚³éå®Œæ•´çš„ä»»å‹™è³‡æ–™
    }
  }

  const handleDragStart = (event: DragStartEvent) => {
    const { active } = event
    setActiveTaskId(active.id as string)
  }

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event
    setActiveTaskId(null)

    if (!over) return

    const activeTaskId = active.id as string
    
    // å¾ over.data ç²å–åˆ—è¡¨IDï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ over.idï¼ˆç•¶æ‹–åˆ°ç©ºåˆ—è¡¨æ™‚ï¼‰
    let overListId = over.data.current?.listId as string
    
    // å¦‚æœæ²’æœ‰ listIdï¼Œæª¢æŸ¥ over.id æ˜¯å¦æ˜¯åˆ—è¡¨IDï¼ˆç”¨æ–¼ç©ºåˆ—è¡¨æƒ…æ³ï¼‰
    if (!overListId) {
      // æª¢æŸ¥ over.id æ˜¯å¦åŒ¹é…ä»»ä½•åˆ—è¡¨ID
      const matchingList = kanbanLists.find(list => list.id === over.id)
      if (matchingList) {
        overListId = matchingList.id
      }
    }

    // æ‰¾åˆ°è¢«æ‹–æ‹½çš„ä»»å‹™æ‰€åœ¨çš„åˆ—è¡¨
    let sourceListId = ''
    for (const list of kanbanLists) {
      if (list.tasks.some(t => t.id === activeTaskId)) {
        sourceListId = list.id
        break
      }
    }

    if (!sourceListId || !overListId) {
      console.log('ç„¡æ³•ç¢ºå®šä¾†æºæˆ–ç›®æ¨™åˆ—è¡¨', { sourceListId, overListId, over })
      return
    }

    // å¦‚æœæ²’æœ‰ç§»å‹•åˆ°ä¸åŒçš„åˆ—è¡¨ï¼Œå‰‡ä¸åšä»»ä½•æ“ä½œ
    if (sourceListId === overListId && !over.data.current?.sortable) return

    try {
      // èª¿ç”¨ API ç§»å‹•ä»»å‹™
      const response = await fetch(
        `/api/communities/${communityId}/kanban/tasks/${activeTaskId}/move`,
        {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            targetListId: overListId,
          }),
        }
      )

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'ç§»å‹•ä»»å‹™å¤±æ•—')
      }

      // é‡æ–°è¼‰å…¥ Kanban è³‡æ–™ä»¥æ›´æ–° UI
      await loadKanban()
    } catch (error: any) {
      console.error('ç§»å‹•ä»»å‹™éŒ¯èª¤:', error)
      alert(error.message || 'ç§»å‹•ä»»å‹™å¤±æ•—')
    }
  }

  const handleDeleteTask = async (taskId: string, listId: string) => {
    if (!communityId) {
      alert('ç¤¾ç¾¤è³‡è¨ŠéŒ¯èª¤')
      return
    }

    setOpenTaskMenuId(null)

    // ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿç¢ºèªå°è©±æ¡†
    if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
      try {
        const response = await fetch(
          `/api/communities/${communityId}/kanban?type=task&id=${taskId}`,
          {
            method: 'DELETE',
          }
        )

        const data = await response.json()

        if (!response.ok) {
          throw new Error(data.error || 'åˆªé™¤ä»»å‹™å¤±æ•—')
        }

        // é‡æ–°è¼‰å…¥ Kanban è³‡æ–™
        await loadKanban()
        alert('ä»»å‹™å·²åˆªé™¤')
      } catch (error: any) {
        console.error('åˆªé™¤ä»»å‹™éŒ¯èª¤:', error)
        alert(error.message || 'åˆªé™¤ä»»å‹™å¤±æ•—')
      }
    }
  }

  const handleCloseAddTaskModal = () => {
    setIsAddTaskModalOpen(false)
    setEditingTask(null)
  }

  // é»æ“Šå¤–éƒ¨é—œé–‰ä»»å‹™é¸å–®
  useEffect(() => {
    if (!openTaskMenuId) return

    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as HTMLElement
      // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨é¸å–®å…§æˆ–ä¸‰å€‹é»æŒ‰éˆ•ä¸Š
      const isClickInsideMenu = target.closest('.task-menu-container')
      const isClickOnMenuButton = target.closest('.task-menu-button')
      
      if (!isClickInsideMenu && !isClickOnMenuButton) {
        setOpenTaskMenuId(null)
      }
    }

    // ä½¿ç”¨ setTimeout ç¢ºä¿åœ¨ç•¶å‰äº‹ä»¶è™•ç†å®Œæˆå¾Œå†æ·»åŠ ç›£è½å™¨
    const timeoutId = setTimeout(() => {
      document.addEventListener('mousedown', handleClickOutside)
    }, 0)

    return () => {
      clearTimeout(timeoutId)
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [openTaskMenuId])

  // è¨ˆç®—å¤šä¹…å‰å‰µç«‹çš„ä»»å‹™
  const getTimeAgo = (createdAt: string): string => {
    const now = new Date()
    const created = new Date(createdAt)
    const diffInSeconds = Math.floor((now.getTime() - created.getTime()) / 1000)

    if (diffInSeconds < 60) {
      return 'å‰›å‰›'
    } else if (diffInSeconds < 3600) {
      const minutes = Math.floor(diffInSeconds / 60)
      return `${minutes}åˆ†é˜å‰`
    } else if (diffInSeconds < 86400) {
      const hours = Math.floor(diffInSeconds / 3600)
      return `${hours}å°æ™‚å‰`
    } else if (diffInSeconds < 604800) {
      const days = Math.floor(diffInSeconds / 86400)
      return `${days}å¤©å‰`
    } else if (diffInSeconds < 2592000) {
      const weeks = Math.floor(diffInSeconds / 604800)
      return `${weeks}é€±å‰`
    } else if (diffInSeconds < 31536000) {
      const months = Math.floor(diffInSeconds / 2592000)
      return `${months}å€‹æœˆå‰`
    } else {
      const years = Math.floor(diffInSeconds / 31536000)
      return `${years}å¹´å‰`
    }
  }

  // æ ¼å¼åŒ–æ—¥æœŸç¯„åœ
  const formatDateRange = (startDate: string, endDate: string): string => {
    // è™•ç†æ—¥æœŸæ ¼å¼ï¼šå¯èƒ½æ˜¯ ISO æ ¼å¼æˆ– YYYY-MM-DD æ ¼å¼
    const formatDate = (dateStr: string): string => {
      if (!dateStr) return ''
      // å¦‚æœæ˜¯ ISO æ ¼å¼ï¼Œæå–æ—¥æœŸéƒ¨åˆ†
      const date = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr
      // è½‰æ›ç‚º YYYY/MM/DD æ ¼å¼
      return date.replace(/-/g, '/')
    }
    
    if (!startDate && !endDate) return ''
    if (!startDate) return formatDate(endDate)
    if (!endDate) return formatDate(startDate)
    return `${formatDate(startDate)}~${formatDate(endDate)}`
  }

  // ç²å–æˆå“¡ä¿¡æ¯ï¼ˆæ ¹æ“šä½¿ç”¨è€…IDï¼‰
  const getMemberInfo = (userId: string) => {
    const member = communityMembers.find((m) => m.id === userId)
    if (member) {
      return member
    }
    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›é è¨­å€¼
    return { id: userId, name: 'æœªçŸ¥', avatar: '' }
  }

  // å®šç¾©ä¸€çµ„è‰²èª¿å·®ç•°æ˜é¡¯çš„é¡è‰²ï¼ˆç”¨æ–¼å€åˆ†ä¸åŒä½¿ç”¨è€…ï¼‰
  const USER_COLORS = [
    'rgba(138,99,210,0.9)',  // ç´«è‰²ï¼ˆåŸæœ¬çš„é¡è‰²ï¼‰
    'rgba(59,130,246,0.9)',  // è—è‰²
    'rgba(16,185,129,0.9)',  // ç¶ è‰²
    'rgba(245,158,11,0.9)',  // æ©™è‰²
    'rgba(239,68,68,0.9)',   // ç´…è‰²
    'rgba(14,165,233,0.9)',  // é’è‰²
    'rgba(168,85,247,0.9)',  // æ·ºç´«è‰²
    'rgba(236,72,153,0.9)',  // ç²‰è‰²
    'rgba(34,197,94,0.9)',   // æ·ºç¶ è‰²
    'rgba(249,115,22,0.9)',  // æ©˜è‰²
  ]

  // æ ¹æ“šä½¿ç”¨è€…IDç”Ÿæˆå›ºå®šé¡è‰²ï¼ˆç¢ºä¿åŒä¸€å€‹ä½¿ç”¨è€…ç¸½æ˜¯å¾—åˆ°ç›¸åŒé¡è‰²ï¼‰
  const getUserColor = (userId: string): string => {
    if (!userId) return USER_COLORS[0]
    
    // ç°¡å–®çš„ hash å‡½æ•¸ï¼šå°‡ userId è½‰æ›ç‚ºæ•¸å­—
    let hash = 0
    for (let i = 0; i < userId.length; i++) {
      const char = userId.charCodeAt(i)
      hash = ((hash << 5) - hash) + char
      hash = hash & hash // è½‰æ›ç‚º 32 ä½æ•´æ•¸
    }
    
    // ä½¿ç”¨çµ•å°å€¼å–æ¨¡ï¼Œç¢ºä¿ç´¢å¼•åœ¨ç¯„åœå…§
    const index = Math.abs(hash) % USER_COLORS.length
    return USER_COLORS[index]
  }

  // å¦‚æœæ­£åœ¨æŸ¥çœ‹æ´»å‹•ï¼Œé¡¯ç¤ºèª²ç¨‹ç›®æ¨™é é¢
  if (viewingActivity) {
    // éæ¿¾å‡ºè©²æ´»å‹•çš„æ”¶æ–‚çµæœç¯€é»ä¸¦è½‰æ›æ ¼å¼
    const convergenceResults = ideas
      .filter(idea => idea.isConvergence && idea.activityId === viewingActivity.id)
      .map(idea => ({
        id: idea.id,
        stage: idea.stage,
        title: idea.title,
        content: idea.content,
        createdDate: idea.createdDate,
        createdTime: idea.createdTime,
      }))

    return (
      <CourseObjectives
        activityName={viewingActivity.name}
        activityId={viewingActivity.id}
        onBack={handleBackFromActivity}
        onSidebarClick={handleSidebarClickFromActivity}
        convergenceResults={convergenceResults}
        onVersionCreated={(activityId, versionData) => {
          // ç‰ˆæœ¬å·²å‰µå»ºï¼Œå¯ä»¥è§¸ç™¼é‡æ–°è¼‰å…¥ç‰ˆæœ¬åˆ—è¡¨
          console.log('ç‰ˆæœ¬å·²å‰µå»º:', activityId, versionData)
        }}
      />
    )
  }

  return (
    <div className="w-screen h-screen min-w-[1280px] min-h-[800px] bg-[#F5F3FA] flex">
      {/* å·¦å´å°èˆªæ¬„ */}
      <div className="w-[80px] bg-[#FAFAFA] flex flex-col items-center py-8 gap-6">
        {/* å°èˆªé¸é … */}
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`w-12 h-12 flex items-center justify-center rounded-lg transition-colors ${
              activeTab === tab.id
                ? 'bg-purple-100 text-purple-600'
                : 'text-gray-600 hover:bg-gray-200'
            }`}
            title={tab.label}
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              {tab.id === 'resources' && (
                // è³‡æºåœ–æ¨™
                <>
                  <path
                    d="M3 7V17C3 18.1046 3.89543 19 5 19H19C20.1046 19 21 18.1046 21 17V9C21 7.89543 20.1046 7 19 7H13L11 5H5C3.89543 5 3 5.89543 3 7Z"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </>
              )}
              {tab.id === 'activities' && (
                // å…±å‚™æ´»å‹•åœ–æ¨™ - æ›¸æœ¬
                <>
                  <path
                    d="M4 19.5C4 18.837 4.26339 18.2011 4.73223 17.7322C5.20107 17.2634 5.83696 17 6.5 17H20"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M6.5 2H20V22H6.5C5.83696 22 5.20107 21.7366 4.73223 21.2678C4.26339 20.7989 4 20.163 4 19.5V4.5C4 3.83696 4.26339 3.20107 4.73223 2.73223C5.20107 2.26339 5.83696 2 6.5 2Z"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </>
              )}
              {tab.id === 'ideas' && (
                // æƒ³æ³•ç‰†åœ–æ¨™ - ç™¼å…‰çš„ç‡ˆæ³¡
                <>
                  <circle
                    cx="12"
                    cy="9"
                    r="5"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M9 14.5C9 14.5 9 16 9 17C9 17.5 9.5 18 10 18H14C14.5 18 15 17.5 15 17C15 16 15 14.5 15 14.5"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M10 21H14"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  {/* ç™¼å…‰æ•ˆæœ */}
                  <path
                    d="M12 2V3"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                  <path
                    d="M19 9H20"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                  <path
                    d="M4 9H5"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                  <path
                    d="M17.5 4.5L16.8 5.2"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                  <path
                    d="M6.5 4.5L7.2 5.2"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                </>
              )}
              {tab.id === 'teamwork' && (
                // åœ˜éšŠåˆ†å·¥åœ–æ¨™ - å‰ªè²¼æ¿ä»»å‹™æ¸…å–®
                <>
                  {/* å‰ªè²¼æ¿ä¸»é«” */}
                  <path
                    d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  {/* å‰ªè²¼æ¿é ‚éƒ¨å¤¾å­ */}
                  <path
                    d="M9 3C9 2.44772 9.44772 2 10 2H14C14.5523 2 15 2.44772 15 3V5H9V3Z"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  {/* æ¸…å–®é …ç›®ç·šæ¢ */}
                  <path
                    d="M9 9H15"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                  <path
                    d="M9 12H15"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                  <path
                    d="M9 15H13"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                  />
                  {/* å‹¾é¸æ¨™è¨˜ */}
                  <path
                    d="M9 17L11 19L15 15"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </>
              )}
              {tab.id === 'history' && (
                // æ´»å‹•æ­·ç¨‹åœ–æ¨™
                <>
                  <path
                    d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M14 2V8H20"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M16 13H8"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M16 17H8"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M10 9H9H8"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </>
              )}
              {tab.id === 'management' && (
                // ç¤¾ç¾¤ç®¡ç†åœ–æ¨™
                <>
                  <path
                    d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <circle
                    cx="9"
                    cy="7"
                    r="4"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                  <path
                    d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </>
              )}
            </svg>
          </button>
        ))}
      </div>

      {/* ä¸»è¦å…§å®¹å€ */}
      <div className="flex-1 flex flex-col">
        {/* Header */}
        <div className="bg-[#FAFAFA] px-8 py-3 flex items-center justify-between">
          {/* å·¦å´ï¼šç¤¾ç¾¤åœ–æ¨™å’Œåç¨±ï¼ˆå¯é»æ“Šè¿”å›ï¼‰ */}
          <button
            onClick={onBack}
            className="flex items-center gap-3 hover:opacity-80 transition-opacity cursor-pointer"
            title="è¿”å›ç¤¾ç¾¤ç¸½è¦½"
          >
            <div className="w-8 h-8 bg-gradient-to-br from-purple-600 to-purple-400 rounded-lg flex items-center justify-center">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                className="text-white"
              >
                <path
                  d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <circle
                  cx="9"
                  cy="7"
                  r="4"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
                <path
                  d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </div>
            <h2 className="text-lg font-semibold text-gray-800">{communityName}</h2>
          </button>

          {/* å³å´ï¼šé€šçŸ¥å’Œç”¨æˆ¶é ­åƒ */}
          <div className="flex items-center gap-6">
            {/* é€šçŸ¥éˆ´éºçµ„ä»¶ */}
            {userId && (
              <NotificationBell 
                userId={userId} 
                communityId={communityId || undefined} 
              />
            )}

            {/* ç”¨æˆ¶é ­åƒèˆ‡ä¸‹æ‹‰é¸å–® */}
            <div className="relative">
              {/* ä½¿ç”¨è€…é ­åƒ */}
              <div
                ref={avatarRef}
                onClick={handleAvatarClick}
                className="w-10 h-10 rounded-full flex items-center justify-center overflow-hidden cursor-pointer hover:opacity-90 transition-opacity"
                style={{ backgroundColor: userId ? getUserColor(userId) : 'rgba(138,99,210,0.9)' }}
              >
                <span className="text-white font-semibold text-sm">
                  {userNickname.charAt(0).toUpperCase()}
                </span>
              </div>

              {/* ä¸‹æ‹‰é¸å–® */}
              {isDropdownOpen && (
                <div
                  ref={dropdownRef}
                  className="absolute right-0 top-12 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50"
                >
                  {/* ä½¿ç”¨è€…è³‡è¨Š */}
                  <div className="px-4 py-3">
                    <div className="text-gray-900 text-base mb-1">
                      {userNickname}
                    </div>
                    <div className="text-sm text-gray-600">
                      {userAccount}
                    </div>
                  </div>

                  {/* åˆ†éš”ç·š */}
                  <div className="border-t border-gray-200 my-1"></div>

                  {/* ç™»å‡º */}
                  <button
                    onClick={handleLogout}
                    className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors"
                  >
                    ç™»å‡º
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* å…§å®¹å€ */}
        <div className="flex-1 bg-[#FEFBFF] px-12 py-8">
          {/* æ¨™é¡Œæ¬„ */}
          <div className="flex items-center justify-between mb-8">
            <h1 className="text-2xl font-bold text-[#6D28D9]">
              {activeTab === 'resources' && 'ç¤¾ç¾¤è³‡æº'}
              {activeTab === 'activities' && 'å…±å‚™æ´»å‹•'}
              {activeTab === 'ideas' && 'æƒ³æ³•ç‰†'}
              {activeTab === 'teamwork' && 'åœ˜éšŠåˆ†å·¥'}
              {activeTab === 'history' && 'æ´»å‹•æ­·ç¨‹'}
              {activeTab === 'management' && 'ç¤¾ç¾¤ç®¡ç†'}
            </h1>
            {activeTab === 'resources' && (
              <>
                <input
                  ref={fileInputRef}
                  type="file"
                  className="hidden"
                  onChange={handleFileChange}
                  accept="*/*"
                />
                <button
                  onClick={handleAddFileClick}
                  className="px-6 py-2 bg-[rgba(138,99,210,0.9)] text-white rounded-lg font-medium hover:bg-[rgba(138,99,210,1)] transition-colors"
                >
                  + æ–°å¢æª”æ¡ˆ
                </button>
              </>
            )}
            {activeTab === 'activities' && (
              <button
                onClick={() => {
                  setEditingActivity(null) // æ¸…é™¤ç·¨è¼¯ç‹€æ…‹
                  setIsAddActivityModalOpen(true)
                }}
                className="px-6 py-2 bg-[rgba(138,99,210,0.9)] text-white rounded-lg font-medium hover:bg-[rgba(138,99,210,1)] transition-colors"
              >
                æ–°å¢æ´»å‹•
              </button>
            )}
          </div>

          {/* å…§å®¹å€åŸŸ */}
          {activeTab !== 'ideas' && (
          <div className="bg-white rounded-lg shadow-sm min-h-[400px] p-8">
            {activeTab === 'resources' && (
              <>
                {resources.length === 0 ? (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    <p className="text-lg">ç›®å‰æ²’æœ‰è³‡æº</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {resources.map((resource) => (
                      <ResourceCard
                        key={resource.id}
                        fileName={resource.fileName}
                        uploadDate={resource.uploadDate}
                        uploadTime={resource.uploadTime}
                        uploaderName={resource.uploaderName}
                        uploaderId={resource.uploaderId}
                        onDelete={() => handleDeleteResource(resource.id)}
                        onDownload={() => handleDownloadResource(resource.id)}
                      />
                    ))}
                  </div>
                )}
              </>
            )}
            {activeTab === 'activities' && (
                <>
                  {activities.length === 0 ? (
              <div className="flex items-center justify-center h-full text-gray-400">
                <p className="text-lg">ç›®å‰æ²’æœ‰æ´»å‹•</p>
              </div>
                  ) : (
                    <div className="space-y-4">
                      {activities.map((activity) => (
                        <ActivityCard
                          key={activity.id}
                          activityName={activity.name}
                          introduction={activity.introduction}
                          createdDate={activity.createdDate}
                          createdTime={activity.createdTime}
                          password={activity.password}
                          isPasswordVerified={passwordVerifiedActivityIds.has(activity.id)}
                          creatorId={activity.creatorId}
                          creatorName={activity.creatorName}
                          onEdit={() => handleEditActivity(activity.id)}
                          onManageVersion={() => handleManageVersion(activity.id)}
                          onDelete={() => handleDeleteActivity(activity.id)}
                          onCardClick={() => handleCardClick(activity.id)}
                          onRequestPassword={(action) => handleRequestPassword(activity.id, action)}
                          onPasswordVerified={() => {
                            // å¯†ç¢¼é©—è­‰æˆåŠŸå¾Œï¼Œå¦‚æœæ˜¯å¾é¸å–®è§¸ç™¼çš„ï¼Œé¸å–®æœƒè‡ªå‹•æ‰“é–‹
                          }}
                        />
                      ))}
              </div>
                  )}
                </>
            )}
            {activeTab === 'teamwork' && (
              <DndContext
                sensors={sensors}
                collisionDetection={closestCorners}
                onDragStart={handleDragStart}
                onDragEnd={handleDragEnd}
              >
                <div className="w-full overflow-x-auto">
                  <div className="flex gap-4 min-w-max p-4">
                    {/* æ–°å¢åˆ—è¡¨æŒ‰éˆ• */}
                  {!isAddingList ? (
                    <button
                      onClick={() => setIsAddingList(true)}
                      className="h-fit px-4 py-2 bg-[rgba(138,99,210,0.9)] text-white rounded-lg font-medium hover:bg-[rgba(138,99,210,1)] transition-colors whitespace-nowrap"
                    >
                      + æ–°å¢åˆ—è¡¨
                    </button>
                  ) : (
                    <div className="w-48 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                      <input
                        type="text"
                        value={newListTitle}
                        onChange={(e) => setNewListTitle(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            handleAddList()
                          } else if (e.key === 'Escape') {
                            setIsAddingList(false)
                            setNewListTitle('')
                          }
                        }}
                        placeholder="è¼¸å…¥åˆ—è¡¨åç¨±"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 text-gray-800 mb-2"
                        autoFocus
                      />
                      <div className="flex gap-2">
                        <button
                          onClick={handleAddList}
                          className="flex-1 px-3 py-1.5 bg-[rgba(138,99,210,0.9)] text-white rounded-lg text-sm font-medium hover:bg-[rgba(138,99,210,1)] transition-colors"
                        >
                          æ–°å¢
                        </button>
                        <button
                          onClick={() => {
                            setIsAddingList(false)
                            setNewListTitle('')
                          }}
                          className="flex-1 px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors"
                        >
                          å–æ¶ˆ
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Kanban åˆ—è¡¨ */}
                  {kanbanLists.map((list) => (
                    <div
                      key={list.id}
                      className="w-48 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col"
                    >
                      {/* åˆ—è¡¨æ¨™é¡Œå’Œåˆªé™¤æŒ‰éˆ• */}
                      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200">
                        <h3 className="font-semibold text-gray-800">{list.title}</h3>
                        <button
                          onClick={() => handleDeleteList(list.id)}
                          className="text-gray-400 hover:text-gray-600 transition-colors"
                          title="åˆªé™¤åˆ—è¡¨"
                        >
                          <svg
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <path
                              d="M18 6L6 18M6 6L18 18"
                              stroke="currentColor"
                              strokeWidth="2"
                              strokeLinecap="round"
                              strokeLinejoin="round"
                            />
                          </svg>
                        </button>
                      </div>

                      {/* æ–°å¢ä»»å‹™æŒ‰éˆ• - ç·Šè²¼åœ¨æ¨™é¡Œä¸‹æ–¹ */}
                      <div className="px-4 py-3">
                        <button
                          onClick={() => handleAddTask(list.id)}
                          className="w-full px-4 py-2 bg-[rgba(138,99,210,0.9)] text-white rounded-lg font-medium hover:bg-[rgba(138,99,210,1)] transition-colors"
                        >
                          æ–°å¢ä»»å‹™
                        </button>
                      </div>

                      {/* ä»»å‹™åˆ—è¡¨å€åŸŸ */}
                      <SortableContext
                        items={list.tasks.map(t => t.id)}
                        strategy={verticalListSortingStrategy}
                        id={list.id}
                      >
                        <DroppableList 
                          id={list.id} 
                          isEmpty={list.tasks.length === 0}
                        >
                          {list.tasks.map((task) => (
                            <DraggableTaskCard
                              key={task.id}
                              id={task.id}
                              task={task}
                              listId={list.id}
                              onEdit={() => handleEditTask(task.id, list.id)}
                              onDelete={() => handleDeleteTask(task.id, list.id)}
                              getUserColor={getUserColor}
                              getMemberInfo={getMemberInfo}
                              formatDateRange={formatDateRange}
                              openMenuId={openTaskMenuId}
                              setOpenMenuId={setOpenTaskMenuId}
                            />
                          ))}
                        </DroppableList>
                      </SortableContext>
                    </div>
                  ))}
                </div>
              </div>
              </DndContext>
            )}
            {activeTab === 'history' && (
              <div className="flex-1 px-8 py-6">
                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                  {/* åœ–è¡¨åˆ‡æ›æŒ‰éˆ• */}
                  <div className="flex gap-3 mb-6">
                    <button
                      onClick={() => setActiveHistoryChart('contribution')}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                        activeHistoryChart === 'contribution'
                          ? 'bg-[rgba(138,99,210,0.9)] text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ç¤¾ç¾¤æƒ³æ³•è²¢ç»æ•¸é‡åœ–
                    </button>
                    <button
                      onClick={() => setActiveHistoryChart('network')}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                        activeHistoryChart === 'network'
                          ? 'bg-[rgba(138,99,210,0.9)] text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ç¤¾ç¾¤ç¶²çµ¡åœ–
                    </button>
                    <button
                      onClick={() => setActiveHistoryChart('trend')}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                        activeHistoryChart === 'trend'
                          ? 'bg-[rgba(138,99,210,0.9)] text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ç¤¾ç¾¤æƒ³æ³•è²¢ç»æ•¸é‡è®ŠåŒ–åœ–è¡¨
                    </button>
                  </div>

                  {/* æ ¹æ“šé¸ä¸­çš„åœ–è¡¨é¡å‹é¡¯ç¤ºå°æ‡‰å…§å®¹ */}
                  {communityId && (
                    <div>
                      {activeHistoryChart === 'contribution' && (
                        <IdeaContributionChart communityId={communityId} />
                      )}
                      {activeHistoryChart === 'network' && (
                        communityId ? (
                          <NetworkGraph communityId={communityId} />
                        ) : (
                          <div className="flex items-center justify-center h-96 text-gray-400">
                            <p className="text-lg">è¼‰å…¥ä¸­...</p>
                          </div>
                        )
                      )}
                      {activeHistoryChart === 'trend' && (
                        <IdeaTrendChart communityId={communityId} />
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}
            {activeTab === 'management' && (
              <div className="flex-1 px-8 py-6">
                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                  {/* æ¨™é¡Œ */}
                  <h2 className="text-xl font-semibold text-gray-800 mb-6">
                    æ‰€æœ‰æˆå“¡({fullCommunityMembers.length})
                  </h2>

                  {/* æˆå“¡åˆ—è¡¨ */}
                  <div className="space-y-4">
                    {fullCommunityMembers.map((member) => {
                      // åˆ¤æ–·ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºç®¡ç†å“¡
                      const currentUser = fullCommunityMembers.find(m => m.userId === userId)
                      const isCurrentUserAdmin = currentUser?.role === 'admin'
                      const isCurrentUser = member.userId === userId
                      const canManage = isCurrentUserAdmin && !isCurrentUser

                      return (
                        <div 
                          key={member.id}
                          className="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors relative"
                        >
                          <div className="flex items-center gap-4 flex-1">
                            {/* é ­åƒ */}
                            <div 
                              className="w-12 h-12 rounded-full flex items-center justify-center text-white text-lg font-semibold"
                              style={{ backgroundColor: getUserColor(member.userId) }}
                            >
                              {member.nickname ? member.nickname.charAt(0).toUpperCase() : 'U'}
                            </div>

                            {/* æˆå“¡è³‡è¨Š */}
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <h3 className="text-base font-semibold text-gray-800">
                                  {member.nickname || member.account}
                                </h3>
                                {member.role === 'admin' && (
                                  <span className="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-medium rounded">
                                    ç®¡ç†å“¡
                                  </span>
                                )}
                              </div>
                              <p className="text-sm text-gray-500">
                                {member.school || 'æœªæä¾›å­¸æ ¡è³‡è¨Š'}
                              </p>
                            </div>
                          </div>

                          {/* ç®¡ç†å“¡ç·¨è¼¯æŒ‰éˆ•ï¼ˆåªå°éè‡ªå·±çš„æˆå“¡é¡¯ç¤ºï¼‰ */}
                          {canManage && (
                            <div className="relative member-menu-container">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  setOpenMemberMenuId(openMemberMenuId === member.userId ? null : member.userId)
                                }}
                                className="text-gray-400 hover:text-gray-600 p-2 rounded hover:bg-gray-100 transition-colors"
                              >
                                <svg
                                  width="20"
                                  height="20"
                                  viewBox="0 0 20 20"
                                  fill="currentColor"
                                  xmlns="http://www.w3.org/2000/svg"
                                >
                                  <circle cx="10" cy="4" r="1.5" />
                                  <circle cx="10" cy="10" r="1.5" />
                                  <circle cx="10" cy="16" r="1.5" />
                                </svg>
                              </button>

                              {/* ä¸‹æ‹‰é¸å–® */}
                              {openMemberMenuId === member.userId && (
                                <div className="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50 member-menu-container">
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation()
                                      setOpenMemberMenuId(null)
                                      handleToggleAdmin(member.userId, member.role === 'admin')
                                    }}
                                    className="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                                  >
                                    {member.role === 'admin' ? (
                                      <>
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                          <path d="M8 1L10.09 6.26L16 7.27L12 11.14L12.91 16.02L8 13.77L3.09 16.02L4 11.14L0 7.27L5.91 6.26L8 1Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                        </svg>
                                        å–æ¶ˆç®¡ç†å“¡
                                      </>
                                    ) : (
                                      <>
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                          <path d="M8 1L10.09 6.26L16 7.27L12 11.14L12.91 16.02L8 13.77L3.09 16.02L4 11.14L0 7.27L5.91 6.26L8 1Z" fill="currentColor"/>
                                        </svg>
                                        è¨­ç‚ºç®¡ç†å“¡
                                      </>
                                    )}
                                  </button>
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation()
                                      setOpenMemberMenuId(null)
                                      handleRemoveMember(member.userId, member.nickname || member.account)
                                    }}
                                    className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                                  >
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                      <path d="M2 4H14" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                                      <path d="M12.6667 4V13.3333C12.6667 14 12 14.6667 11.3333 14.6667H4.66667C4 14.6667 3.33333 14 3.33333 13.3333V4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                                      <path d="M5.33333 4V2.66667C5.33333 2 6 1.33334 6.66667 1.33334H9.33333C10 1.33334 10.6667 2 10.6667 2.66667V4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                                    </svg>
                                    ç§»å‡ºç¤¾ç¾¤
                                  </button>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )
                    })}
                    
                    {/* å¦‚æœæ²’æœ‰æˆå“¡è³‡æ–™ */}
                    {fullCommunityMembers.length === 0 && (
                      <div className="text-center py-8 text-gray-400">
                        <p>è¼‰å…¥ä¸­...</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
          )}

          {/* æƒ³æ³•ç‰†ï¼ˆç¨ç«‹å®¹å™¨ï¼Œç„¡ç™½è‰²èƒŒæ™¯ï¼‰ */}
          {activeTab === 'ideas' && (
            <div className="flex-1 relative overflow-y-auto -mt-6">
              {/* æƒ³æ³•æ”¶æ–‚æŒ‰éˆ• */}
              <button 
                onClick={() => setIsConvergenceModalOpen(true)}
                className="px-6 py-2.5 bg-[rgba(138,99,210,0.9)] hover:bg-[rgba(138,99,210,1)] text-white rounded-lg font-medium transition-colors mb-2"
              >
                æƒ³æ³•æ”¶æ–‚
              </button>
              
              {/* é‚Šç•Œç·š */}
              <div className="border-t-2 border-gray-300 mb-4"></div>

              {/* æƒ³æ³•å…§å®¹å€åŸŸ */}
              <div className="px-12 relative" id="ideas-container" style={{ minHeight: '600px' }}>
                {ideas.length === 0 ? (
                  <div className="text-gray-400 text-center py-12">
                    <p>ç›®å‰é‚„æ²’æœ‰æƒ³æ³•</p>
        </div>
                ) : (
                  <>
                    {/* æƒ³æ³•å¡ç‰‡ - è‡ªç”±æ‹–æ‹‰å¸ƒå±€ */}
                    <div className="relative" style={{ minHeight: '600px' }}>
                      {ideas.map((idea, index) => {
                        // æ ¹æ“š creatorNameï¼ˆnicknameï¼‰å¾ communityMembers ä¸­æ‰¾åˆ°å°æ‡‰çš„ userId
                        const creatorMember = communityMembers.find(
                          (m) => m.name === idea.creatorName
                        )
                        const creatorId = creatorMember?.id || undefined
                        
                        return (
                          <DraggableIdeaCard
                            key={idea.id}
                            id={idea.id}
                            index={index}
                            stage={idea.stage}
                            title={idea.title}
                            createdDate={idea.createdDate}
                            createdTime={idea.createdTime}
                            creatorName={idea.creatorName}
                            creatorAvatar={idea.creatorAvatar}
                            creatorId={creatorId}
                            position={idea.position || { x: 50 + index * 200, y: 50 }}
                            rotation={idea.rotation || 0}
                            onClick={() => handleEditIdea(idea.id)}
                            onPositionChange={handleIdeaPositionChange}
                            onRotationChange={handleIdeaRotationChange}
                            isConvergence={idea.isConvergence}
                          />
                        )
                      })}
                    </div>
                    
                    {/* ç®­é ­é€£æ¥ç·šå±¤ - ä½¿ç”¨å–®ä¸€ SVG è¦†è“‹å±¤ */}
                    <ArrowsOverlay ideas={ideas} />
                  </>
                )}
              </div>

              {/* å³ä¸‹è§’æµ®å‹•æ–°å¢æŒ‰éˆ• */}
              <button
                onClick={() => setIsAddIdeaModalOpen(true)}
                className="fixed bottom-8 right-8 w-14 h-14 bg-[rgba(138,99,210,0.9)] hover:bg-[rgba(138,99,210,1)] rounded-full shadow-lg flex items-center justify-center text-white text-2xl font-light transition-colors z-10"
              >
                +
              </button>
            </div>
          )}
        </div>
      </div>

      {/* æ–°å¢/ç·¨è¼¯æ´»å‹•æ¨¡æ…‹æ¡† */}
      <AddActivityModal
        isOpen={isAddActivityModalOpen}
        onClose={handleCloseAddActivityModal}
        onAdd={handleAddActivity}
        editMode={!!editingActivity}
        initialData={
          editingActivity
            ? {
                name: editingActivity.name,
                isPublic: editingActivity.isPublic,
                password: editingActivity.password,
                introduction: editingActivity.introduction,
              }
            : undefined
        }
        onManageVersion={
          editingActivity
            ? () => {
                setIsAddActivityModalOpen(false)
                handleManageVersion(editingActivity.id)
              }
            : undefined
        }
      />

      {/* å¯†ç¢¼é©—è­‰æ¨¡æ…‹æ¡† */}
      {passwordVerifyingActivity && (
        <PasswordModal
          isOpen={isPasswordModalOpen}
          onClose={handleClosePasswordModal}
          onVerify={handlePasswordVerify}
          activityName={passwordVerifyingActivity.name}
        />
      )}

      {/* æ–°å¢/ç·¨è¼¯ä»»å‹™æ¨¡æ…‹æ¡† */}
      <AddTaskModal
        isOpen={isAddTaskModalOpen}
        onClose={handleCloseAddTaskModal}
        onSubmit={handleSubmitTask}
        communityMembers={communityMembers}
        editMode={!!editingTask}
        initialData={
          editingTask
            ? (() => {
                const list = kanbanLists.find((l) => l.id === editingTask.listId)
                const task = list?.tasks.find((t) => t.id === editingTask.taskId)
                if (task) {
                  // å°‡ assigneesï¼ˆæš±ç¨±é™£åˆ—ï¼‰è½‰æ›ç‚ºä½¿ç”¨è€…IDé™£åˆ—
                  const assigneeIds = task.assignees.map((nickname: string) => {
                    const member = communityMembers.find((m) => m.name === nickname)
                    return member ? member.id : null
                  }).filter((id: string | null) => id !== null) as string[]

                  return {
                    category: task.title,
                    content: task.content,
                    startDate: task.startDate,
                    endDate: task.endDate,
                    assignees: assigneeIds, // è½‰æ›ç‚ºä½¿ç”¨è€…IDé™£åˆ—
                  }
                }
                return undefined
              })()
            : undefined
        }
      />

      {/* æ–°å¢æƒ³æ³•æ¨¡æ…‹æ¡† */}
      <AddIdeaModal
        isOpen={isAddIdeaModalOpen}
        onClose={() => {
          setIsAddIdeaModalOpen(false)
          setExtendingFromIdeaId(null) // æ¸…é™¤å»¶ä¼¸ä¾†æº
        }}
        onSubmit={handleAddIdea}
        communityId={communityId || undefined}
      />

      {/* ç·¨è¼¯æƒ³æ³•æ¨¡æ…‹æ¡† */}
      {editingIdea && (
        <EditIdeaModal
          isOpen={isEditIdeaModalOpen}
          onClose={handleCloseEditIdeaModal}
          onSave={handleSaveIdea}
          onDelete={handleDeleteIdea}
          onExtend={handleExtendIdea}
          initialData={{
            activityId: editingIdea.activityId,
            stage: editingIdea.stage,
            title: editingIdea.title,
            content: editingIdea.content,
          }}
          isConvergence={editingIdea.isConvergence}
          communityId={communityId || undefined}
        />
      )}

      {/* æƒ³æ³•æ”¶æ–‚æ¨¡æ…‹æ¡† */}
      {isConvergenceModalOpen && (
        <ConvergenceModal
          ideas={ideas}
          onClose={() => setIsConvergenceModalOpen(false)}
          onSubmit={handleConvergenceSubmit}
          communityId={communityId || undefined}
          userId={userId}
          userAccount={userAccount}
        />
      )}

      {/* ç‰ˆæœ¬ç®¡æ§è¦–çª— */}
      <VersionControlModal
        isOpen={isVersionControlModalOpen}
        onClose={handleCloseVersionControlModal}
        activityId={versionControlActivityId || ''}
        activityName={
          versionControlActivityId
            ? activities.find((a) => a.id === versionControlActivityId)?.name || ''
            : ''
        }
        onRestore={handleRestoreVersion}
      />
    </div>
  )
}



