# 社群網絡圖實施計劃

## 功能需求分析

根據圖片 3-5-50，需要實現：

1. **網絡圖顯示**
   - 節點：社群成員（圓點）
   - 邊（箭頭）：成員間的回覆關係（有向邊）
   - 節點大小：根據互動活躍度

2. **點擊節點顯示詳細統計**
   - 該成員建立的總節點數
   - 回覆的節點數
   - 被回覆的節點數量
   - 兩個表格：
     - 「回覆過的節點」表格（來源、數量）
     - 「被回覆的節點」表格（來源、數量）

## 技術基礎檢查

✅ `react-force-graph-2d` 已安裝（版本 1.29.0）
✅ 資料庫結構完整（ideas 表有 parent_id 和 creator_id）
✅ 已有類似的圖表組件可參考（IdeaContributionChart、IdeaTrendChart）

## 分階段實施計劃

### 🎯 Phase 1: API 資料統計（最安全，獨立性高）
**成功率：95%** ⏱️ 2-3 小時

**目標**：建立 API 獲取網絡圖所需的所有資料

**需要實現**：
1. 建立 `/api/communities/[communityId]/network-graph` 路由
2. 查詢並返回：
   - 節點資料（所有社群成員）
   - 邊資料（回覆關係）
   - 每個節點的統計資料（建立數、回覆數、被回覆數）

**資料結構設計**：
```typescript
{
  nodes: [
    {
      id: string,           // userId
      label: string,        // 使用者名稱
      createdCount: number, // 建立的節點數
      replyCount: number,   // 回覆的節點數
      receivedReplyCount: number, // 被回覆的節點數
    }
  ],
  edges: [
    {
      from: string,         // 回覆者的 userId
      to: string,           // 被回覆者的 userId
      value: number,        // 回覆次數
    }
  ],
  statistics: {
    [userId]: {
      createdCount: number,
      replyCount: number,
      receivedReplyCount: number,
      replyTable: [        // 回覆過的節點列表
        { source: string, count: number }
      ],
      receivedReplyTable: [ // 被回覆的節點列表
        { source: string, count: number }
      ]
    }
  }
}
```

**風險**：低
- 只建立新的 API 路由，不修改現有代碼
- 可以獨立測試 API 返回的資料
- 即使有問題，不會影響系統啟動

---

### 🎯 Phase 2: 基本網絡圖顯示（中等風險）
**成功率：85%** ⏱️ 3-4 小時

**目標**：顯示網絡圖，能看到節點和邊

**需要實現**：
1. 建立 `NetworkGraph.tsx` 組件
2. 使用 `react-force-graph-2d` 顯示基本網絡圖
3. 整合到 `CommunityDetail.tsx`

**風險控制**：
- 先不實現點擊功能
- 使用最簡單的配置，確保能顯示
- 如果無法顯示，可以快速回滾

**回滾方案**：移除組件導入，恢復佔位訊息

---

### 🎯 Phase 3: 點擊互動和統計顯示（中等風險）
**成功率：80%** ⏱️ 3-4 小時

**目標**：點擊節點顯示詳細統計面板

**需要實現**：
1. 添加點擊事件處理
2. 顯示統計面板（Modal 或側邊面板）
3. 顯示兩個統計表格

**風險控制**：
- 分步驟添加：先顯示基本統計，再加表格
- 確保 Modal 可以正確關閉

---

### 🎯 Phase 4: 樣式優化和細節完善（低風險）
**成功率：90%** ⏱️ 2-3 小時

**目標**：優化外觀和互動體驗

**需要實現**：
1. 節點大小根據活躍度調整
2. 節點顏色區分
3. 邊的粗細表示回覆頻率
4. 響應式設計

---

## 總體評估

| 階段 | 功能 | 成功率 | 風險 | 時間 |
|------|------|--------|------|------|
| Phase 1 | API 資料統計 | 95% | 低 | 2-3h |
| Phase 2 | 基本網絡圖顯示 | 85% | 中 | 3-4h |
| Phase 3 | 點擊互動和統計 | 80% | 中 | 3-4h |
| Phase 4 | 樣式優化 | 90% | 低 | 2-3h |
| **總計** | **完整功能** | **85%** | **中** | **10-14h** |

## 推薦實施順序

### 最安全的方案（推薦）
1. **先做 Phase 1**：只建立 API，測試 API 返回的資料是否正確
2. **測試確認後**：再進行 Phase 2
3. **逐步推進**：每個階段都測試確認，再進行下一步

### 為什麼這樣分階段？

1. **Phase 1 最安全**：
   - 只新增 API 文件，不修改現有代碼
   - 即使 API 有問題，不影響系統啟動
   - 可以通過瀏覽器直接測試 API

2. **Phase 2-4 可以分離**：
   - 每個階段都可以獨立回滾
   - 不會一次改太多導致無法定位問題

3. **便於測試**：
   - 每階段完成後都可以測試
   - 發現問題可以立即修復，不會累積

## 風險點和應對措施

### 風險點 1：react-force-graph-2d 的兼容性
**應對**：
- 先建立最簡單的測試組件
- 如果無法導入或運行，可以考慮替代方案

### 風險點 2：資料查詢複雜度高
**應對**：
- Phase 1 專注於資料查詢
- 使用多個簡單查詢，而不是複雜 JOIN
- 在應用層組裝資料

### 風險點 3：點擊事件處理
**應對**：
- 使用 React 的標準事件處理
- 確保 Modal 狀態管理正確
- 測試多個節點的點擊

## 回滾準備

每個階段都會創建獨立的回滾說明文件：
- `ROLLBACK_NETWORK_GRAPH_PHASE1.md`
- `ROLLBACK_NETWORK_GRAPH_PHASE2.md`
- `ROLLBACK_NETWORK_GRAPH_PHASE3.md`

## 建議

**從 Phase 1 開始**，因為：
1. 最安全，不會影響系統啟動
2. 可以驗證資料邏輯是否正確
3. 為後續階段打好基礎

要我開始 Phase 1 嗎？

